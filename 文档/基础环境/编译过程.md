# c的编译过程
- ![demo](images/c-complie.jpg "编译过程")

- 从功能上分，预处理、编译、汇编是三个不同的阶段，但GCC的实际操作上，它可以把这三个步骤合并为一个步骤来执行
```
gcc -o test test.c
```

## 预处理阶段
- 在预处理阶段，输入的是C语言的源文件，通常为*.c。它们通常带有.h之类头文件的包含文件
- 这个阶段主要处理源文件中的#ifdef、 #include和#define命令。该阶段会生成一个中间文件*.i
- 但实际工作中通常不用专门生成这种文件，因为基本上用不到
- 若非要生成这种文件不可，可以利用下面的示例命令：
```
gcc -E  test.c -o test.i
```

## 编译阶段
- 在编译阶段，输入的是中间文件*.i，编译后生成汇编语言文件*.s
- 编译时，编译器需要的是语法的正确，函数与变量的声明的正确
- 通常是你需要告诉编译器头文件的所在位置（头文件中应该只是声明，而定义应该放在C/C++文件中），只要所有的语法正确，编译器就可以编译出中间目标文件
- 一般来说，每个源文件都应该对应于一个中间目标文件

```
gcc -S test.i -o test.s 
```

## 汇编阶段
- 在汇编阶段，将输入的汇编文件*.s转换成机器语言*.o
```
gcc -c test.s -o test.o 
```

## 连接(link)阶段
- 在连接阶段将输入的机器代码文件*.s（与其它的机器代码文件和库文件）汇集成一个可执行的二进制代码文件
- 连接时，主要是连接函数和全局变量，所以，我们可以使用这些中间目标文件（O文件）来连接我们的应用程序
- 链接器并不管函数所在的源文件，只管函数的中间目标文件（Object File）
- 在编译时，编译器只检测程序语法，和函数、变量是否被声明。如果函数未被声明，编译器会给出一个警告，但可以生成Object File。
- 而在链接程序时，链接器会在所有的Object File中找寻函数的实现，如果找不到，那到就会报链接错误码（Linker Error）

```
gcc test.o -o test
gcc test1.0 test2.0 test3.0 -o testnew
```

### 库文件
- 在大多数时候，由于源文件太多，编译生成的中间目标文件太多，而在链接时需要明显地指出中间目标文件名，这对于编译很不方便
- 给中间目标文件打个包，在Windows下这种包叫“库文件”（Library File)，也就是 .lib 文件，在UNIX下，是Archive File，也就是 .a 文件
- 也有一种类型是.so文件。windows是.dll文件

#### 静态库文件
- 包含内容

```
1. 包含一个对应的头文件告知编译器lib文件里面的具体内容
2. 设置lib文件允许编译器去查找已经编译好的二进制代码
```

- 在链接之后， lib库中需要的资源已经在可执行程序中了， 也就是静态存在，没有依赖性了 
- 做成静态库可执行文件本身比较大，但不必附带动态库

####  动态库文件
- 也是将中间目标代码打包生成的文件，一般是.so文件
- 程序运行时需要加载动态库，对动态库有依赖性，需要手动加入动态库  
- 做成动态库可执行文件本身比较小，但需要附带动态库 



## 简洁化使用
- 从源文件直接生成可执行文件
```
gcc -o test test.c
```

- 从源文件生成机器文件
```
gcc -c test.c -o test.o
```

- 也可以从多个源文件一起编译直接生成一个可执行文件
```
gcc -o test  first.c second.c third.c

```

- 多个机器文件，一起生成可执行文件
```
gcc test1.o test2.o test3.o -o test
```

- 机器文件，源文件混合一起生成可执行文件
```
gcc test1.o test2.c test3.c test4.o -o test
```

- 需要注意的是，要生成可执行程序时，一个程序无论有有一个源文件还是多个源文件，所有被编译和连接的源文件中必须有且仅有一个main函数，因为main函数是该程序的入口点

## 目标文件与可执行文件的理解

- 一般"目标文件"指的就是"机器语言"文件
- “目标文件" 有时也称为 ”中间代码文件“
- "可执行文件"是指将多个目标文件合并而成的可以直接执行的机器文件


- 从源文件直接生成目标文件即机器语言文件
```
gcc -c test.c -o test.o
```



## 常用参数
### 指定头文件目录
- 许多情况下，头文件和源文件会单独存放在不同的目录中，通过"-I"参数告诉gcc，去哪里找头文件，可以使用多次
```
gcc test.c –I../inc –I../../inc2 -o test
```
